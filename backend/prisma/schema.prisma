generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RequestStatus {
  open
  quoted
  accepted
  in_progress
  completed
  cancelled
}

enum QuoteStatus {
  pending
  accepted
  rejected
  expired
}

enum JobStatus {
  pending
  pending_confirmation
  in_progress
  completed
  cancelled
}

model User {
  id String @id @default(uuid())

  // External Auth Provider (Clerk, Auth0, Supabase - easily swappable)
  externalAuthId String @unique // Clerk: "user_xxx", Auth0: "auth0|xxx"
  authProvider   String @default("clerk") // "clerk", "auth0", "supabase"

  // User data (synced from auth provider via webhook)
  email     String    @unique
  name      String
  phone     String?   @unique
  avatarUrl String?
  roles     String[]  @default(["owner"])
  deletedAt DateTime? // Soft delete

  // Address (moved from OwnerProfile)
  address String?
  city    String?
  state   String?
  zipCode String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Profiles
  providerProfile ProviderProfile?

  // Relations
  ownedVehicles         Vehicle[]        @relation("VehicleOwner")
  serviceRequests       ServiceRequest[] @relation("RequestOwner")
  providedQuotes        Quote[]          @relation("QuoteProvider")
  providerJobs          Job[]            @relation("JobProvider")
  ownerJobs             Job[]            @relation("JobOwner")
  notifications         Notification[]
  sentMessages          Message[]        @relation("MessageSender")
  ownerConversations    Conversation[]   @relation("ConversationOwner")
  providerConversations Conversation[]   @relation("ConversationProvider")
  ownerProfile          OwnerProfile?

  @@index([externalAuthId])
  @@index([authProvider])
  @@map("users")
}

model OwnerProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  onboardingComplete Boolean @default(false)
  address            String?
  city               String?
  state              String?
  zipCode            String?
  avatarUrl          String?
  bio                String?

  stripeCardId String? // Mock storage for default card
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  stripeCustomerId String?
}

model ProviderProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  isActive        Boolean   @default(false)
  statusReason    String?
  statusChangedAt DateTime?

  // Business Information
  businessName    String?  @unique
  serviceTypes    String[] @default([])
  yearsInBusiness Int?
  website         String?
  hourlyRate      Decimal? @db.Decimal(10, 2)

  // Location & Service Area
  shopAddress String?
  shopCity    String?
  shopState   String?
  shopZipCode String?
  serviceArea String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([serviceTypes], type: Gin)
  @@map("provider_profiles")
}

model Vehicle {
  id           String    @id @default(uuid())
  ownerId      String
  make         String
  model        String
  year         Int
  vin          String?
  licensePlate String?
  color        String?
  mileage      Int?
  imageUrls    String[]  @default([])
  deletedAt    DateTime? // Soft delete
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  owner           User             @relation("VehicleOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  serviceRequests ServiceRequest[]

  @@index([ownerId])
  @@map("vehicles")
}

model ServiceRequest {
  id          String        @id @default(uuid())
  vehicleId   String
  ownerId     String
  title       String
  description String
  urgency     String // 'low' | 'medium' | 'high' | 'urgent'
  status      RequestStatus @default(open)
  imageUrls   String[]      @default([])
  deletedAt   DateTime? // Soft delete
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  owner   User    @relation("RequestOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  quotes  Quote[]
  jobs    Job[]

  @@index([vehicleId])
  @@index([ownerId])
  @@index([status])
  @@index([status, createdAt])
  @@map("service_requests")
}

model Quote {
  id                String      @id @default(uuid())
  requestId         String
  providerId        String
  amount            Decimal     @db.Decimal(10, 2)
  laborCost         Decimal?    @db.Decimal(10, 2)
  partsCost         Decimal?    @db.Decimal(10, 2)
  estimatedDuration String
  notes             String? // Deprecated - use description instead
  description       String?
  includesWarranty  Boolean     @default(false)
  status            QuoteStatus @default(pending)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  request  ServiceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  provider User           @relation("QuoteProvider", fields: [providerId], references: [id], onDelete: Cascade)
  jobs     Job[]

  @@index([requestId])
  @@index([providerId])
  @@map("quotes")
}

model Job {
  id          String    @id @default(uuid())
  quoteId     String
  requestId   String
  providerId  String
  ownerId     String
  status      JobStatus @default(pending)
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  quote        Quote          @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  request      ServiceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  provider     User           @relation("JobProvider", fields: [providerId], references: [id], onDelete: Cascade)
  owner        User           @relation("JobOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  conversation Conversation?

  @@index([quoteId])
  @@index([requestId])
  @@index([providerId])
  @@index([ownerId])
  @@map("jobs")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String // 'quote_received' | 'request_updated' | 'booking_confirmed' | 'setup_reminder'
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String? // Optional link to related resource
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@map("notifications")
}

model Conversation {
  id            String    @id @default(uuid())
  jobId         String    @unique
  ownerId       String
  providerId    String
  lastMessageAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  job      Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  owner    User      @relation("ConversationOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  provider User      @relation("ConversationProvider", fields: [providerId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([ownerId])
  @@index([providerId])
  @@map("conversations")
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  isRead         Boolean  @default(false)
  createdAt      DateTime @default(now())

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}
